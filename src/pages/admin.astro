---
export const prerender = false;
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>SnapBet Admin</title>
        <style>
            * {
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: linear-gradient(
                    135deg,
                    #0a0a0f 0%,
                    #1a1a2e 50%,
                    #0a0a0f 100%
                );
                color: #fff;
                margin: 0;
                padding: 20px;
                min-height: 100vh;
            }
            .container {
                max-width: 1000px;
                margin: 0 auto;
            }
            h1 {
                color: #ffe600;
                margin-bottom: 20px;
                animation: glow 2s ease-in-out infinite alternate;
            }
            @keyframes glow {
                from {
                    text-shadow: 0 0 10px rgba(255, 230, 0, 0.3);
                }
                to {
                    text-shadow:
                        0 0 20px rgba(255, 230, 0, 0.6),
                        0 0 30px rgba(255, 230, 0, 0.4);
                }
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            @keyframes pulse {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.02);
                }
            }
            .login-form,
            .admin-panel {
                background: rgba(30, 30, 40, 0.8);
                padding: 24px;
                border-radius: 16px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                animation: slideUp 0.5s ease-out;
            }
            .login-form h3 {
                margin-top: 0;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .login-form h3::before {
                content: "üîê";
                font-size: 1.5rem;
            }
            input,
            button {
                padding: 12px 18px;
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                font-size: 14px;
                transition: all 0.2s ease;
            }
            input {
                background: rgba(0, 0, 0, 0.4);
                color: #fff;
                width: 100%;
                max-width: 300px;
            }
            input:focus {
                outline: none;
                border-color: #ffe600;
                box-shadow: 0 0 10px rgba(255, 230, 0, 0.2);
            }
            button {
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                color: #fff;
                cursor: pointer;
                border: none;
                margin-left: 10px;
                font-weight: 600;
            }
            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            }
            button:active {
                transform: translateY(0);
            }
            button.danger {
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            }
            button.danger:hover {
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            }
            button.warning {
                background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            }
            button.warning:hover {
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            }
            button.logout {
                background: rgba(100, 100, 100, 0.5);
                margin-left: auto;
            }
            button.logout:hover {
                background: rgba(150, 150, 150, 0.5);
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            th,
            td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            th {
                color: #888;
                font-weight: 500;
                text-transform: uppercase;
                font-size: 12px;
            }
            tr {
                transition: background 0.2s ease;
            }
            tr:hover {
                background: rgba(255, 255, 255, 0.05);
            }
            .address {
                font-family: monospace;
                font-size: 12px;
            }
            .actions {
                display: flex;
                gap: 8px;
            }
            .status {
                padding: 12px 16px;
                border-radius: 8px;
                margin-bottom: 20px;
                animation: fadeIn 0.3s ease-out;
            }
            .status.error {
                background: rgba(239, 68, 68, 0.2);
                border: 1px solid #ef4444;
                color: #fca5a5;
            }
            .status.success {
                background: rgba(16, 185, 129, 0.2);
                border: 1px solid #10b981;
                color: #6ee7b7;
            }
            .hidden {
                display: none;
            }
            .stats {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
            }
            .stat-card {
                background: rgba(0, 0, 0, 0.3);
                padding: 20px 28px;
                border-radius: 12px;
                flex: 1;
                border: 1px solid rgba(255, 255, 255, 0.05);
                animation: slideUp 0.5s ease-out;
                animation-fill-mode: backwards;
            }
            .stat-card:nth-child(1) {
                animation-delay: 0.1s;
            }
            .stat-card:nth-child(2) {
                animation-delay: 0.2s;
            }
            .stat-card h3 {
                margin: 0 0 8px 0;
                color: #888;
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            .stat-card .value {
                font-size: 28px;
                font-weight: bold;
                background: linear-gradient(135deg, #ffe600 0%, #ffa500 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            .header-row {
                display: flex;
                align-items: center;
                margin-bottom: 20px;
            }
            .header-row h1 {
                margin: 0;
            }
            .login-error {
                color: #fca5a5;
                margin-top: 12px;
                padding: 10px;
                background: rgba(239, 68, 68, 0.1);
                border-radius: 8px;
                border: 1px solid rgba(239, 68, 68, 0.3);
                animation: shake 0.5s ease-in-out;
            }
            @keyframes shake {
                0%,
                100% {
                    transform: translateX(0);
                }
                20%,
                60% {
                    transform: translateX(-5px);
                }
                40%,
                80% {
                    transform: translateX(5px);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header-row">
                <h1>üõ†Ô∏è SnapBet Admin</h1>
            </div>

            <div id="login-section" class="login-form">
                <h3>Enter Admin Password</h3>
                <div
                    style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;"
                >
                    <input
                        type="password"
                        id="password"
                        placeholder="Password..."
                    />
                    <button id="login-btn">üîì Login</button>
                </div>
                <div id="login-error" class="login-error hidden"></div>
            </div>

            <div id="admin-section" class="admin-panel hidden">
                <div
                    style="display: flex; align-items: center; margin-bottom: 20px;"
                >
                    <span style="color: #10b981;">‚úì Authenticated</span>
                    <button id="logout-btn" class="logout">üö™ Logout</button>
                </div>

                <div id="status" class="status hidden"></div>

                <div class="stats">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div id="total-users" class="value">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Balance</h3>
                        <div id="total-balance" class="value">-</div>
                    </div>
                </div>

                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button id="refresh-btn">üîÑ Refresh</button>
                    <button id="reset-btn" class="warning"
                        >‚ö†Ô∏è Reset All Balances</button
                    >
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Address</th>
                            <th>ENS</th>
                            <th>Balance</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table"></tbody>
                </table>
            </div>
        </div>

        <script is:inline>
            let password = "";

            function setCookie(name, value, days) {
                const expires = new Date(
                    Date.now() + days * 864e5,
                ).toUTCString();
                document.cookie =
                    name +
                    "=" +
                    encodeURIComponent(value) +
                    "; expires=" +
                    expires +
                    "; path=/; SameSite=Strict";
            }

            function getCookie(name) {
                const value = "; " + document.cookie;
                const parts = value.split("; " + name + "=");
                if (parts.length === 2)
                    return decodeURIComponent(parts.pop().split(";").shift());
                return null;
            }

            function deleteCookie(name) {
                document.cookie =
                    name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            }

            function login() {
                const input = document.getElementById("password");
                password = input ? input.value : "";
                const errorEl = document.getElementById("login-error");
                if (errorEl) errorEl.classList.add("hidden");
                loadUsers();
            }

            function logout() {
                password = "";
                deleteCookie("admin_session");
                const loginSection = document.getElementById("login-section");
                const adminSection = document.getElementById("admin-section");
                if (loginSection) loginSection.classList.remove("hidden");
                if (adminSection) adminSection.classList.add("hidden");
                const pwdInput = document.getElementById("password");
                if (pwdInput) pwdInput.value = "";
            }

            async function loadUsers() {
                try {
                    const res = await fetch("/api/admin", {
                        headers: { "X-Admin-Password": password },
                    });
                    const data = await res.json();

                    if (data.error) {
                        const errorEl = document.getElementById("login-error");
                        if (errorEl) {
                            errorEl.textContent = "‚ùå " + data.error;
                            errorEl.classList.remove("hidden");
                        }
                        deleteCookie("admin_session");
                        return;
                    }

                    // Save session
                    setCookie("admin_session", password, 1);

                    const loginSection =
                        document.getElementById("login-section");
                    const adminSection =
                        document.getElementById("admin-section");
                    if (loginSection) loginSection.classList.add("hidden");
                    if (adminSection) adminSection.classList.remove("hidden");

                    const users = data.users || [];
                    const totalUsersEl = document.getElementById("total-users");
                    const totalBalanceEl =
                        document.getElementById("total-balance");
                    if (totalUsersEl)
                        totalUsersEl.textContent = String(users.length);
                    if (totalBalanceEl)
                        totalBalanceEl.textContent =
                            "$" +
                            users.reduce(function (sum, u) {
                                return sum + u.balance;
                            }, 0);

                    const tbody = document.getElementById("users-table");
                    if (tbody) {
                        tbody.innerHTML = users
                            .map(function (u) {
                                return (
                                    "<tr>" +
                                    '<td class="address">' +
                                    u.address +
                                    "</td>" +
                                    "<td>" +
                                    (u.ens_name || "-") +
                                    "</td>" +
                                    '<td><input type="number" value="' +
                                    u.balance +
                                    '" id="balance-' +
                                    u.address +
                                    '" style="width: 80px;"></td>' +
                                    "<td>" +
                                    (u.updated_at
                                        ? new Date(
                                              u.updated_at * 1000,
                                          ).toLocaleString()
                                        : "-") +
                                    "</td>" +
                                    '<td class="actions">' +
                                    "<button onclick=\"updateUser('" +
                                    u.address +
                                    "')\">üíæ Save</button>" +
                                    '<button class="danger" onclick="deleteUser(\'' +
                                    u.address +
                                    "')\">üóëÔ∏è</button>" +
                                    "</td>" +
                                    "</tr>"
                                );
                            })
                            .join("");
                    }

                    showStatus("Loaded " + users.length + " users", "success");
                } catch (e) {
                    showStatus(
                        "Failed to load: " +
                            (e instanceof Error ? e.message : String(e)),
                        "error",
                    );
                }
            }

            async function updateUser(address) {
                const input = document.getElementById("balance-" + address);
                const balance = input ? parseInt(input.value) : 0;
                try {
                    const res = await fetch("/api/admin", {
                        method: "POST",
                        headers: {
                            "X-Admin-Password": password,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            action: "update",
                            address: address,
                            balance: balance,
                        }),
                    });
                    const data = await res.json();
                    showStatus(
                        data.message || data.error,
                        data.error ? "error" : "success",
                    );
                    if (!data.error) loadUsers();
                } catch (e) {
                    showStatus(
                        "Update failed: " +
                            (e instanceof Error ? e.message : String(e)),
                        "error",
                    );
                }
            }

            async function deleteUser(address) {
                if (!confirm("Delete user " + address + "?")) return;
                try {
                    const res = await fetch("/api/admin", {
                        method: "POST",
                        headers: {
                            "X-Admin-Password": password,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            action: "delete",
                            address: address,
                        }),
                    });
                    const data = await res.json();
                    showStatus(
                        data.message || data.error,
                        data.error ? "error" : "success",
                    );
                    if (!data.error) loadUsers();
                } catch (e) {
                    showStatus(
                        "Delete failed: " +
                            (e instanceof Error ? e.message : String(e)),
                        "error",
                    );
                }
            }

            async function resetAll() {
                if (!confirm("Reset ALL user balances to $1000?")) return;
                try {
                    const res = await fetch("/api/admin", {
                        method: "POST",
                        headers: {
                            "X-Admin-Password": password,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ action: "reset_all" }),
                    });
                    const data = await res.json();
                    showStatus(
                        data.message || data.error,
                        data.error ? "error" : "success",
                    );
                    if (!data.error) loadUsers();
                } catch (e) {
                    showStatus(
                        "Reset failed: " +
                            (e instanceof Error ? e.message : String(e)),
                        "error",
                    );
                }
            }

            function showStatus(msg, type) {
                const el = document.getElementById("status");
                if (el) {
                    el.textContent = (type === "success" ? "‚úì " : "‚úó ") + msg;
                    el.className = "status " + type;
                    el.classList.remove("hidden");
                    setTimeout(function () {
                        el.classList.add("hidden");
                    }, 4000);
                }
            }

            document.addEventListener("DOMContentLoaded", function () {
                const loginBtn = document.getElementById("login-btn");
                const refreshBtn = document.getElementById("refresh-btn");
                const resetBtn = document.getElementById("reset-btn");
                const logoutBtn = document.getElementById("logout-btn");

                if (loginBtn) loginBtn.addEventListener("click", login);
                if (refreshBtn) refreshBtn.addEventListener("click", loadUsers);
                if (resetBtn) resetBtn.addEventListener("click", resetAll);
                if (logoutBtn) logoutBtn.addEventListener("click", logout);

                const pwdInput = document.getElementById("password");
                if (pwdInput) {
                    pwdInput.addEventListener("keypress", function (e) {
                        if (e.key === "Enter") login();
                    });
                }

                // Check for saved session
                const savedSession = getCookie("admin_session");
                if (savedSession) {
                    password = savedSession;
                    loadUsers();
                }
            });
        </script>
    </body>
</html>
