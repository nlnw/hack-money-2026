---
export const prerender = false;
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>SnapBet Admin</title>
        <style>
            * {
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: #0a0a0f;
                color: #fff;
                margin: 0;
                padding: 20px;
                min-height: 100vh;
            }
            .container {
                max-width: 1000px;
                margin: 0 auto;
            }
            h1 {
                color: #ffe600;
                margin-bottom: 20px;
            }
            .login-form,
            .admin-panel {
                background: rgba(30, 30, 40, 0.8);
                padding: 24px;
                border-radius: 12px;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            input,
            button {
                padding: 10px 16px;
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                font-size: 14px;
            }
            input {
                background: rgba(0, 0, 0, 0.3);
                color: #fff;
                width: 100%;
                max-width: 300px;
            }
            button {
                background: #3b82f6;
                color: #fff;
                cursor: pointer;
                border: none;
                margin-left: 10px;
            }
            button:hover {
                opacity: 0.9;
            }
            button.danger {
                background: #ef4444;
            }
            button.warning {
                background: #f59e0b;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            th,
            td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            th {
                color: #888;
                font-weight: 500;
            }
            .address {
                font-family: monospace;
                font-size: 12px;
            }
            .actions {
                display: flex;
                gap: 8px;
            }
            .status {
                padding: 10px;
                border-radius: 8px;
                margin-bottom: 20px;
            }
            .status.error {
                background: rgba(239, 68, 68, 0.2);
                border: 1px solid #ef4444;
            }
            .status.success {
                background: rgba(16, 185, 129, 0.2);
                border: 1px solid #10b981;
            }
            .hidden {
                display: none;
            }
            .stats {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
            }
            .stat-card {
                background: rgba(0, 0, 0, 0.3);
                padding: 16px 24px;
                border-radius: 8px;
                flex: 1;
            }
            .stat-card h3 {
                margin: 0 0 8px 0;
                color: #888;
                font-size: 12px;
                text-transform: uppercase;
            }
            .stat-card .value {
                font-size: 24px;
                font-weight: bold;
                color: #ffe600;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üõ†Ô∏è SnapBet Admin</h1>

            <div id="login-section" class="login-form">
                <h3>Enter Admin Password</h3>
                <input
                    type="password"
                    id="password"
                    placeholder="Password..."
                />
                <button id="login-btn">Login</button>
            </div>

            <div id="admin-section" class="admin-panel hidden">
                <div id="status" class="status hidden"></div>

                <div class="stats">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div id="total-users" class="value">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Balance</h3>
                        <div id="total-balance" class="value">-</div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <button id="refresh-btn">üîÑ Refresh</button>
                    <button id="reset-btn" class="warning"
                        >‚ö†Ô∏è Reset All Balances</button
                    >
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Address</th>
                            <th>ENS</th>
                            <th>Balance</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table"></tbody>
                </table>
            </div>
        </div>

        <script is:inline>
            // @ts-nocheck
            let password = "";

            function login() {
                const input = document.getElementById("password");
                password = input ? input.value : "";
                loadUsers();
            }

            async function loadUsers() {
                try {
                    const res = await fetch("/api/admin", {
                        headers: { "X-Admin-Password": password },
                    });
                    const data = await res.json();

                    if (data.error) {
                        showStatus(data.error, "error");
                        return;
                    }

                    const loginSection =
                        document.getElementById("login-section");
                    const adminSection =
                        document.getElementById("admin-section");
                    if (loginSection) loginSection.classList.add("hidden");
                    if (adminSection) adminSection.classList.remove("hidden");

                    const users = data.users || [];
                    const totalUsersEl = document.getElementById("total-users");
                    const totalBalanceEl =
                        document.getElementById("total-balance");
                    if (totalUsersEl)
                        totalUsersEl.textContent = String(users.length);
                    if (totalBalanceEl)
                        totalBalanceEl.textContent =
                            "$" +
                            users.reduce(function (sum, u) {
                                return sum + u.balance;
                            }, 0);

                    const tbody = document.getElementById("users-table");
                    if (tbody) {
                        tbody.innerHTML = users
                            .map(function (u) {
                                return (
                                    "<tr>" +
                                    '<td class="address">' +
                                    u.address +
                                    "</td>" +
                                    "<td>" +
                                    (u.ens_name || "-") +
                                    "</td>" +
                                    '<td><input type="number" value="' +
                                    u.balance +
                                    '" id="balance-' +
                                    u.address +
                                    '" style="width: 80px;"></td>' +
                                    "<td>" +
                                    (u.updated_at
                                        ? new Date(
                                              u.updated_at * 1000,
                                          ).toLocaleString()
                                        : "-") +
                                    "</td>" +
                                    '<td class="actions">' +
                                    "<button onclick=\"updateUser('" +
                                    u.address +
                                    "')\">üíæ Save</button>" +
                                    '<button class="danger" onclick="deleteUser(\'' +
                                    u.address +
                                    "')\">üóëÔ∏è</button>" +
                                    "</td>" +
                                    "</tr>"
                                );
                            })
                            .join("");
                    }

                    showStatus("Loaded " + users.length + " users", "success");
                } catch (e) {
                    showStatus(
                        "Failed to load: " +
                            (e instanceof Error ? e.message : String(e)),
                        "error",
                    );
                }
            }

            async function updateUser(address) {
                const input = document.getElementById("balance-" + address);
                const balance = input ? parseInt(input.value) : 0;
                try {
                    const res = await fetch("/api/admin", {
                        method: "POST",
                        headers: {
                            "X-Admin-Password": password,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            action: "update",
                            address: address,
                            balance: balance,
                        }),
                    });
                    const data = await res.json();
                    showStatus(
                        data.message || data.error,
                        data.error ? "error" : "success",
                    );
                    if (!data.error) loadUsers();
                } catch (e) {
                    showStatus(
                        "Update failed: " +
                            (e instanceof Error ? e.message : String(e)),
                        "error",
                    );
                }
            }

            async function deleteUser(address) {
                if (!confirm("Delete user " + address + "?")) return;
                try {
                    const res = await fetch("/api/admin", {
                        method: "POST",
                        headers: {
                            "X-Admin-Password": password,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            action: "delete",
                            address: address,
                        }),
                    });
                    const data = await res.json();
                    showStatus(
                        data.message || data.error,
                        data.error ? "error" : "success",
                    );
                    if (!data.error) loadUsers();
                } catch (e) {
                    showStatus(
                        "Delete failed: " +
                            (e instanceof Error ? e.message : String(e)),
                        "error",
                    );
                }
            }

            async function resetAll() {
                if (!confirm("Reset ALL user balances to $1000?")) return;
                try {
                    const res = await fetch("/api/admin", {
                        method: "POST",
                        headers: {
                            "X-Admin-Password": password,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ action: "reset_all" }),
                    });
                    const data = await res.json();
                    showStatus(
                        data.message || data.error,
                        data.error ? "error" : "success",
                    );
                    if (!data.error) loadUsers();
                } catch (e) {
                    showStatus(
                        "Reset failed: " +
                            (e instanceof Error ? e.message : String(e)),
                        "error",
                    );
                }
            }

            function showStatus(msg, type) {
                const el = document.getElementById("status");
                if (el) {
                    el.textContent = msg;
                    el.className = "status " + type;
                    el.classList.remove("hidden");
                    setTimeout(function () {
                        el.classList.add("hidden");
                    }, 3000);
                }
            }

            // Attach event listeners when DOM is ready
            document.addEventListener("DOMContentLoaded", function () {
                const loginBtn = document.getElementById("login-btn");
                const refreshBtn = document.getElementById("refresh-btn");
                const resetBtn = document.getElementById("reset-btn");

                if (loginBtn) loginBtn.addEventListener("click", login);
                if (refreshBtn) refreshBtn.addEventListener("click", loadUsers);
                if (resetBtn) resetBtn.addEventListener("click", resetAll);

                // Also allow Enter key on password field
                const pwdInput = document.getElementById("password");
                if (pwdInput) {
                    pwdInput.addEventListener("keypress", function (e) {
                        if (e.key === "Enter") login();
                    });
                }
            });
        </script>
    </body>
</html>
